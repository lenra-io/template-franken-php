generator:
  dofigen:
    builders:
      - name: composer-install
        from: composer
        adds:
          - "composer.json"
          - "composer.lock"
        run:
          - composer install --prefer-dist --no-scripts --no-dev --no-autoloader --no-progress --no-suggest --no-interaction -o -a --apcu-autoloader
        caches:
          - /root/.composer
      - name: files
        from: dunglas/frankenphp
        adds:
          - "."
        root: 
          run:
            - mv /app/config/php.ini $PHP_INI_DIR/php.ini
            - pecl install apcu
      - name: composer-autoload
        from: composer-install
        artifacts:
          - builder: files
            source: /app/src
            destination: /app/src
        run: 
          - composer dump-autoload --optimize --classmap-authoritative --apcu
    from: files
    artifacts:
      - builder: composer-autoload
        source: /app/vendor
        destination: /app/vendor
    cmd:
      - docker-php-entrypoint
      - --config
      - /app/config/Caddyfile
      - --adapter
      - caddyfile
    healthcheck:
      cmd: curl -f http://localhost:2019/metrics || exit 1
    ports:
      - 3000
    ignores:
      - "**"
      - "!/src/"
      - "!/composer.*"
      - "!/config/"
